<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hands + Eyes Full Integration</title>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
}

#inputVideo {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

#canvasOutput {
    position: absolute;
    width: 100%;
    height: 100%;
    pointer-events: none;
    transform: scaleX(-1);
}

.hand-point, .eye-point {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 10;
}

.hand-line, .eye-line {
    position: absolute;
    height: 2px;
    pointer-events: none;
    z-index: 9;
}
</style>
</head>

<body>

<video id="inputVideo" autoplay muted playsinline></video>
<canvas id="canvasOutput"></canvas>

<script>
let hands, faceMesh, videoElement, canvasElement, canvasCtx;
let cameraStream = null;
let handElements = [], eyeElements = [];

// MediaPipe initialization
function initMediaPipe() {
    videoElement = document.getElementById('inputVideo');
    canvasElement = document.getElementById('canvasOutput');
    canvasCtx = canvasElement.getContext('2d');

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // --- Hands ---
    hands = new Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
        selfieMode: false
    });
    hands.onResults(onHandsResults);

    // --- FaceMesh (Eyes) ---
    faceMesh = new FaceMesh({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}` });
    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    faceMesh.onResults(onFaceResults);

    startCamera();
}

// Canvas resizing
function resizeCanvas() {
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
}

// Camera and frame loop
async function startCamera() {
    cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
    });
    videoElement.srcObject = cameraStream;

    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({ image: videoElement });
            await faceMesh.send({ image: videoElement });
        },
        width: 640,
        height: 480
    });
    camera.start();
}

// --- HANDS ---
function onHandsResults(results) {
    clearHandElements();
    canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);

    if (!results.multiHandLandmarks) return;

    results.multiHandLandmarks.forEach((landmarks,index) => {
        const isLeft = results.multiHandedness[index].label==='Right';
        drawHand(landmarks, isLeft ? '#00ff00' : '#ff0000');
    });
}

function drawHand(landmarks,color) {
    const points = landmarks.map(lm => ({
        x: (1-lm.x)*window.innerWidth,
        y: lm.y*window.innerHeight
    }));

    points.forEach(p=>{
        const dot = document.createElement('div');
        dot.className='hand-point';
        dot.style.left=(p.x-6)+'px';
        dot.style.top=(p.y-6)+'px';
        dot.style.background=color;
        dot.style.boxShadow=`0 0 10px ${color}`;
        document.body.appendChild(dot);
        handElements.push(dot);
    });

    HAND_CONNECTIONS.forEach(([a,b])=>{
        const p1=points[a], p2=points[b];
        const dx=p2.x-p1.x, dy=p2.y-p1.y;
        const length=Math.hypot(dx,dy);
        const angle=Math.atan2(dy,dx)*180/Math.PI;

        const line=document.createElement('div');
        line.className='hand-line';
        line.style.left=p1.x+'px';
        line.style.top=p1.y+'px';
        line.style.width=length+'px';
        line.style.transform=`rotate(${angle}deg)`;
        line.style.transformOrigin='0 0';
        line.style.background=color.replace(')',',0.4)').replace('rgb','rgba');

        document.body.appendChild(line);
        handElements.push(line);
    });
}

function clearHandElements() {
    handElements.forEach(el=>el.remove());
    handElements=[];
}

// --- EYES ---
function onFaceResults(results) {
    clearEyeElements();
    if(!results.multiFaceLandmarks) return;

    const landmarks = results.multiFaceLandmarks[0];

    // Left and right eyes indices (MediaPipe)
    const leftEyeIndices=[33,133,160,159,158,153,144,145,153,154,155];
    const rightEyeIndices=[362,263,387,386,385,380,373,374,380,381,382];

    drawEyeLandmarks(leftEyeIndices,landmarks,'#00ffff');
    drawEyeLandmarks(rightEyeIndices,landmarks,'#ff00ff');
}

function drawEyeLandmarks(indices,landmarks,color){
    const points = indices.map(i=>({
        x:(1-landmarks[i].x)*window.innerWidth,
        y:landmarks[i].y*window.innerHeight
    }));

    // Points
    points.forEach(p=>{
        const dot = document.createElement('div');
        dot.className='eye-point';
        dot.style.left=(p.x-4)+'px';
        dot.style.top=(p.y-4)+'px';
        dot.style.width='8px';
        dot.style.height='8px';
        dot.style.background=color;
        dot.style.boxShadow=`0 0 8px ${color}`;
        document.body.appendChild(dot);
        eyeElements.push(dot);
    });

    // Lines connecting eye landmarks
    for(let i=0;i<points.length-1;i++){
        const p1=points[i], p2=points[i+1];
        const dx=p2.x-p1.x, dy=p2.y-p1.y;
        const length=Math.hypot(dx,dy);
        const angle=Math.atan2(dy,dx)*180/Math.PI;

        const line=document.createElement('div');
        line.className='eye-line';
        line.style.left=p1.x+'px';
        line.style.top=p1.y+'px';
        line.style.width=length+'px';
        line.style.transform=`rotate(${angle}deg)`;
        line.style.transformOrigin='0 0';
        line.style.background=color.replace(')',',0.4)').replace('rgb','rgba');

        document.body.appendChild(line);
        eyeElements.push(line);
    }
}

function clearEyeElements(){
    eyeElements.forEach(el=>el.remove());
    eyeElements=[];
}

window.addEventListener('load', initMediaPipe);
window.addEventListener('beforeunload',()=>{
    if(cameraStream) cameraStream.getTracks().forEach(t=>t.stop());
});
</script>

</body>
</html>
